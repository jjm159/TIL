# 동시성 문제

운영체제를 들을 때 나는 간신히 C언어 코드를 읽을 수 있는 수준이었다. 그런데도 뭣도 모르고 궁금해서 수강했었다. 중간고사 때 까지만 해도 할 만 했었는데, 뒤에 Concurrency부터 완전히 정신을 못차렸다. 세마포어부터는 이해하는 공부가 아니라 시험을 위한 공부를 했었다. 

그리고 이번에 이렇게 1년만에 다시 이 책을 펼치게 되었다. 와우.. 그런데 1년만에 얼마나 성장했는지 너무 잘읽힌다. 예제로 있는 코드들도 순식간에 읽어내고, 이제는 이해하는 공부가 가능해졌다.

### **경쟁 조건 Race Condition**

명령어의 실행 순서에 따라, 실행 시점에 따라 결과가 달라지는 상황. 비결정적인(indetermine) 결과가 나오는 상황. Atomic하게 실행되어야 하는 코드 영역의 중간에 다른 스레드가 이 코드를 또 실행시켜서 발생.

### 임계 구역 Critical Section

Atomic하게 실행되어야 하는 코드 영역. 이 구역이 끝나기 전에 다른 스레드에서 이 구역에 침입하면 경쟁조건이 발생. 

### 상호배제 Mutual Exclusion

임계 구역을 침범하여 경쟁조건을 방지하려면 '상호 배제'가 실현되어야 한다. 상호 배제는 임계 구역 내의 코드가 어떤 스레드에 의해 실행 중이라면, 다른 스레드가 이 코드 영역을 실행할 수 없도록 보장해주는 것이다. 상호배제를 실현시키는 방법이 락, 컨디션 변수, 세마포어이다.

### 락 Lock

기본적으로 상호배제를 실현하는 방법이다. 임계 구역의 시작부분과 끝 부분에 락, 언락 함수를 실행시켜준다. 락 함수가 실행되면, 해당 스레드는 락을 획득하게 된다. 이 때 스케줄링에 의해 다른 스레드가 이 락 함수를 실행 시켜 임계 영역에 침범하려고 하면 락함수는 락 변수가 사용중인지 확인하고, 만약 사용 중이라면 해당 스레드를 무한 대기 시키거나, 바로 제어권을 내어 놓거나, 잠을 자는 방식으로 임계영역 코드를 실행시키지 않고 기다린다. 

대기 하는 방법은 앞서 얘기했든, 대기, 제어권 내놓기, 잠자기가 있다. 무한 대기하는 방법은 스핀 락 이라고 한다. while문으로 계속 조건을 검사하면서 락을 얻기를 시도한다. 이 방법은 스케줄러가 분배해준 time slice를 다 소진할 때까지 계속 된다. 그래서 스레드가 많아질 수록 성능이 좋지 못하다. 실제로 임계 영역을 실행시키는 스레드는 하나 뿐인데, 나머지 n-1이 똑같이 스케줄링되어 cpu 점유권을 가져가기 때문이다. n-1/n 의 cpu 자원이 낭비되고 있는 것이다. 

그래서 락이 없으면 바로 제어권을 내어 놓는 방법도 있다. 하지만 이 것 또한, 계속 Context Switching을 해야 하기 때문에 자원의 낭비가 있다. 그래서 나온 것이 잠자기 방법이다. 락을 확인하고 사용중이라면 스레드를 잠재운다. 그리고 이 스레드를 대기 큐에 집어 넣는다. 락을 가지고 있는 스레드는 임계 영역의 실행이 모두 끝나면, 락을 반환하면서 스레드 큐에 있는 스레드를 깨운다. 그러면 깨워진 스레드가 스케줄러에 의해 실행되어 락을 획득하고 임계 영역을 실행시킬 수 있게 된다. 

### Mutex

Mutual Exclusion 기능을 제공하기 위해 POSIX 라이브러리가 제공해 주는 '락'의 이름이다. 

### 컨디션 변수 Condition variable

멀티 스레드를 통해 병렬적으로 실행하더라도, 각각의 실행 결과를 합쳐야 할 때가 있다. 이 때 다른 스레드가 끝날 때 까지 기다려줄 필요가 있다. 이를 동기화라고 한다. 컨디션 변수는 어떤 조건이 만족할 때 까지 기다리는 방법을 제공해준다. 컨디션 변수는 '큐'이다. 어떤 조건을 만족해야 해당 스레드의 다음 명령을 실행시킬 수 있을 때, 만약 그 조건이 만족되지 못하면 해당 스레드는 wait함수로 잠을 자고 자신을 컨디션 변수에 넣는다. 그리고 다른 스레드에서 어떤 작업을 하게 되면, 다시 잠들었던 스레드를 깨워서 조건이 만족되었는지 확인하도록 한다. 물론 이때에도 만족하지 못하면 다시 잠들게 된다. 

### 세마포어 Semaphore

최단경로 그래프 알고리즘을 개발하고, Goto문의 유해성이라는 논문으로 구조적 프로그래밍 패러다임을 창조한 다익스트라는 모든 동기화 문제를 하나의 방법으로 해결하고자 했다. 그래서 탄생한 것이 세마포어다. 세마포어를 사용하면, 임계 영역의 상호 배제와 동기화 문제를 모두 해결할 수 있다. 락과 컨디션 변수로 모두 사용될 수 있는 하나의 방법인 것이다.

---
### 참고
[운영체제 아주 쉬운 세 가지 이야기](https://book.naver.com/bookdb/book_detail.nhn?bid=11823378)