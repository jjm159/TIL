# ìœ ì € ì»¤ë°‹ìˆ˜ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë°°ì¹˜ ì£¼ê¸° ê³ ë¯¼
- ê¸°ì¤€ í•„ìš”
- github api ìš”ì²­ì˜ limit ê³¼ apiì˜ ì„±ëŠ¥ì„ ê³ ë ¤í•˜ë©´ ëœë‹¤ê³  ìƒê°
- github api ìš”ì²­ì˜ limitëŠ” 5000ê°œ. 1ë¶„ì— í•œë²ˆì”© ìš”ì²­í•´ë„ ë‚¨ëŠ” ê°œìˆ˜
- github apiì˜ ì‘ë‹µì†ë„ê°€ 1ì´ˆì •ë„ë¡œ ë¹„êµì  ëŠë¦°í¸...!!

# ë¹„ë™ê¸° ì´ìŠˆ
- github apië¥¼ ìœ ì € í’€ìŠ¤ìº”í•˜ë©´ì„œ ëŒë¦¬ë©´ 50ëª…ë§Œ ëŒë ¤ë„ 30ì´ˆê°€ ê±¸ë¦¼
- ë¹„ë™ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ê²°

## ì‹¤í—˜ ê²°ê³¼
```
start_time = datetime.now()
result = CommitCountScheduler().job()
print(result)
end_time = datetime.now()
print(end_time-start_time)

start_time = datetime.now()
result = CommitCountScheduler().jobAsync()
print(result)
end_time = datetime.now()
print(end_time-start_time)

```
- ë™ê¸°ì¸ ê²½ìš° 0:00:30.924396ì´ˆ 
- ë¹„ë™ê¸°ì¸ ê²½ìš° 0:00:00.003153ì´ˆ


## ì½”ë“œ

```python
import requests
import json
from datetime import datetime, timedelta, timezone
from configuration.config import Config
from urllib.parse import parse_qs
import aiohttp
import asyncio


class GithubApi:

    def __init__(self):
        self.graphqlUrl = "https://api.github.com/graphql"
        self.restUrl = "https://github.com"
        config = Config()
        self.clientId = config.find("GITHUB_CLIENT_ID")
        self.clientKey = config.find("GITHUB_CLIENT_SECRET")
        self.scope = 'repo%20user'

    def getLoginUrl(self):
        githubLoginUrl = f"https://github.com/login/oauth/authorize?client_id={self.clientId}&scope={self.scope}"
        return githubLoginUrl

    def getAccessToken(self, code):
        headers = {
            "Content-Type": "application/json"
        }

        data = json.dumps({
            "code": code,
            "client_id": self.clientId,
            "client_secret": self.clientKey,
        })

        response = requests.post(self.restUrl + "/login/oauth/access_token", headers=headers, data=data)

        # ê²°ê³¼ ì¶œë ¥
        print("ğŸğŸğŸğŸğŸğŸğŸğŸğŸ")
        if response.status_code == 200:
            resultText = response.text
            parsedQuery = parse_qs(resultText)
            return parsedQuery.get('access_token', [None])[0]
        else:
            print(response.text)


    def getTotalCommitCountToday(self, loginId, accessToken):

        def koreaNowDatetime():
            KST = timezone(timedelta(hours=9))
            return datetime.now(KST)

        def koreaNextDatetime(now):
            tomorrow = now + timedelta(days=1)
            return tomorrow

        def dateTimeToKSTString(date):

            # ë¬¸ìì—´ë¡œ ë³€í™˜ (ISO 8601 í˜•ì‹)
            formatted_time = date.strftime('%Y-%m-%dT%H:%M:%S%z')

            # '+0900'ì„ '+09:00' í˜•ì‹ìœ¼ë¡œ ë³€ê²½
            formatted_time = formatted_time[:-2] + ':' + formatted_time[-2:]

            return formatted_time

        fromDatetime = koreaNowDatetime()
        toDatetime = koreaNextDatetime(fromDatetime)

        return self.getTotalCommitCount(
            loginId=loginId, 
            accessToken=accessToken, 
            fromDatetime=dateTimeToKSTString(fromDatetime), 
            toDatetime=dateTimeToKSTString(toDatetime)
        )
    

    # from, toë¥¼ date íƒ€ì…ìœ¼ë¡œ ë°›ì•„ì„œ, ì•„ë˜ í˜•íƒœë¡œ ë°”ê¿”ì„œ query ë‚ ë¦¬ê¸°
    def getTotalCommitCount(self, loginId, accessToken, fromDatetime, toDatetime):
        query = self.getTotalCommitCountQuery(loginId, fromDatetime=fromDatetime, toDatetime=toDatetime)
        headers = self.getTotalCommitCountHeader(accessToken)
        data = json.dumps({"query": query})
        
        response = requests.post(self.graphqlUrl, headers=headers, data=data)

        print(response.status_code)

        # ê²°ê³¼ ì¶œë ¥
        if response.status_code == 200:
            result = response.json()  # ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±
            try:
                total_commit_contributions = result['data']['user']['contributionsCollection']['totalCommitContributions']
            except KeyError:
                print("The expected key was not found in the response.")
        else:
            print(response.text)

        return total_commit_contributions
    
    def getTotalCommitCountQuery(self, loginId, fromDatetime, toDatetime):
        return f"""
        query {{
            user(login: "{loginId}") {{
                contributionsCollection(from: "{fromDatetime}", to: "{toDatetime}") {{
                    totalCommitContributions
                }}
            }}
        }}
        """

    def getTotalCommitCountHeader(self, accessToken):
        return {
            "Authorization": f"Bearer {accessToken}",
            "Content-Type": "application/json"
        }

    async def getDataAsync(self, url, data, headers):
        async with aiohttp.ClientSession() as session:
            async with session.post(url, data=data, headers=headers) as response:
                if response.status == 200:
                    # JSON ì‘ë‹µì¸ ê²½ìš°
                    body = await response.json()
                    return body
                else:
                    # ì˜¤ë¥˜ ì‘ë‹µì¸ ê²½ìš°
                    error_message = await response.text()
                    print(f"Error: {response.status}, Message: {error_message}")
                    return None
    

    async def getTotalCommitCountTodayAsync(self, loginId, accessToken):

        def nowDatetime():
            # í•œêµ­ì‹œê°„ ê¸°ì¤€, +6 ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•˜ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì´ +6ì„ í•¨ 
            ourZone = timezone(timedelta(hours=9+6))
            return datetime.now(ourZone)

        def nextDatetime(now):
            tomorrow = now + timedelta(days=1)
            return tomorrow

        def dateTimeToKSTString(date):
            formatted_time = date.strftime('%Y-%m-%dT%H:%M:%S%z')
            formatted_time = formatted_time[:-2] + ':' + formatted_time[-2:]
            return formatted_time

        fromDatetime = nowDatetime()
        toDatetime = nextDatetime(fromDatetime)

        return await self.getTotalCommitCountAsync(
            loginId=loginId, 
            accessToken=accessToken, 
            fromDatetime=dateTimeToKSTString(fromDatetime), 
            toDatetime=dateTimeToKSTString(toDatetime)
        )


    async def getTotalCommitCountAsync(self, loginId, accessToken, fromDatetime, toDatetime):
        query = self.getTotalCommitCountQuery(loginId, fromDatetime=fromDatetime, toDatetime=toDatetime)
        headers = self.getTotalCommitCountHeader(accessToken)
        data = json.dumps({"query": query})
        
        response = await self.getDataAsync(url=self.graphqlUrl, data=data, headers=headers)

        return response['data']['user']['contributionsCollection']['totalCommitContributions']


    async def requestGetAllTotalCommitCount(self, list):
        tasks = [self.getTotalCommitCountTodayAsync(item['loginId'], item['accessToken']) for item in list]
        responses = await asyncio.gather(*tasks)
        return responses

    def getAllTotalCommitCount(self, list):
        responses = asyncio.run(self.requestGetAllTotalCommitCount(list))
        return responses
       

```