# 네트워크 계층 - IP
- 물리, 데이터 링크 계층은 대부분 LAN을 위한 기술
- LAN을 넘어서 다른 네트워크와 통신을 주고받기 위한 네트워크 계층 이상의 기술
- IP - Internet Protocol
- IP를 중심으로 네트워크 간의 통신이 이루어지는 방법!!!

---

## IP의 목적과 특징
- __목적__
    - 주소 지정
        - 네트워크 간의 통신 과정에서 호스트를 특정하는 것
    - 단편화
        - 데이터를 여러 IP 패킷으로 올바르게 쪼개어 보내는 것
- __특징__
    - 신뢰할 수 없는 통신
    - 비연결 통신
- 주소 지정
    - 주소 지정은 IP 주소를 통해 이루어진다
    - IP 패킷 헤더에서 송신지 IP 주소, 수신지 IP 주소를 확인하면 된다. 
    - MAC 주소
        - IP 주소는 수신 주소, 발신 주소, MAC 주소는 수신인과 발신인
        - 두 주소를 모두 사용해야 호스트까지 전달 가능
    - 라우터
        - `라우터`라는 네트워크 장비를 사용하여 IP 주소에 해당하는 주소지로 패킷을 보냄
        - IP 패킷을 전달할 최적 경로를 결정하고 패킷을 보내는 것을 라우팅이라고 함
- 단편화
    - `MTU` - Maximum Transmission Unit
        - 최대 전송 단위
    - MTU 보다 IP 패킷(IP 헤더와 페이로드)이 크면, 패킷을 쪼개서 보냄
    - 일반적인 MTU 크기는 1500바이트
    - 프레임을 통해 주고받을 수 있는 최대 페이로드의 크기로 보아도 무방
    - IP 패킷 헤더
        - 식별자: 이 패킷이 어떤 데이터로부터 나온 패킷인지, 데이터에 대한 식별자
        - 플래그: IP 단편화를 해라 하지 마라 결정 
        - 단편화 오프셋: 해당 패킷이 초기 데이터에서 얼마나 떨어져 있는지
- 신뢰할 수 없는 통신
    - 패킷이 수신지까지 제대로 전송되었다고 보장하지 않는 프로토콜
    - 유실되거나 순서가 틀려도 조치를 취하지 않음
    - 최선형 전달 - best effort delivery
- 비연결 통신
    - 사전에 연결 과정을 거치지 않음
    - 그저 패킷을 보낼 뿐 수신지의 상태를 확인하지 않음
- `경로 MTU (Path MTU) 발견으로 IP 단편화 피하기`
    - 잦은 IP 단편화 단점
        - 패킷 수 증가로 인한 패킷 헤더 증가 -> 불필요한 트래픽 증가와 대역폭 낭비
        - 재조립 연산으로 부하 증가 -> 성능 저하
    - 모든 호스트의 처리 가능한 MTU 크기를 고려하고,
    - IP 단편화 없이 주고받을 수 있는 최대 크기 만큼만 전송
    - 이 크기를 경로 MTU라고 함
    - 경로 MTU를 발견하고 IP 단편화를 회피하는 것을 `경로 MTU 발견(Path MTU discovery)`라고 함
---

## IP 주소의 구조
- IP 주소
    - IP 주소는 8비트 4개 총 32 비트로 구성
    - `네트워크 주소`와 `호스트 주소`로 이루어져 있음
    - 이 둘을 표시하는 크기가 동적임
- `클래스풀 주소 체계`
    - 상황에 따라 네트워크 주소와 호스트 주소의 크기가 결정된다.
        - 호스트 주소 공간을 크게 -> IP 주소 낭비
        - 호스트 주소 공간을 작게 -> IP 주소가 부족
        - 어떻게 나눠야 하지?
    - `IP 주소의 클래스`
        - 네트워크의 크기에 따라 __유형별로__ IP 주소를 분류하는 기준
        - 클래스에 따라 네트워크 부분과 호스트 부분이 어느 정도 크기인지 알 수 있음
        - A, B, C, D, E
        - D, E는 멀티캐스트를 위한 클래스, 나머지 세 개 클래스로 IP 주소를 분류해야 함
    - 클래스를 바탕으로 IP 주소를 관리하는 주소 체계를 `클래스풀 주소 체계`라고 함
    - A 클래스: 네트워크 주소가 비트 `0`으로 시작하고 `1옥텟`으로 구성, 호스트 3옥텟
    - B 클래스: 네트워크 주소가 비트 `10`으로 `2옥텟`으로 구성, 호스트 2옥텟
    - C 클래스: 네트워크 주소가 비트 `110`으로 `3옥텟`으로 구성, 호스트 1옥텟
- `클래스 리스 주소 체계`와 `서브넷 마스크`
    - 클래스 주소 체계 -> 고정 크기 외 다른 크기로 네트워크 구성 X, IP 주소 낭비 발생
    - 클래스리스 주소 체계는 `서브넷 마스크`를 사용하여 동적으로 네트워크를 구성
    - `서브넷 마스크`
        - 32비트 중 네트워크 주소를 1로 표기, 호스트 주소를 0으로 표기한 비트열
    - 서브넷 네트워크 or 서브넷(줄여서)
        - IP 주소에서 네트워크 주소로 구분할 수 있는 네트워크의 부분 집합
        - 서브넷 마스크는 서브넷을 구분(마스크)하는 비트열
    - 서브네팅
        - 서브넷 마스크를 사용하여 원하는 크기로 클래스를 쪼개 사용하는 것
    - How? 
        - IP 주소와 서브넷 마스크를 AND 연산 수행하면 IP 주소 내 네트워크 주소를 알 수 있음
    - `CIDR`
        - 서브넷 마스크 표기법
        - Classless Inter-Domain Routing notation
        - IP 주소/서브넷 마스크 상의 1의 개수 로 표현
        - 192.168.20.3/30 -> 서브넷 마스크에 1이 30개 있다는 것
        - 11111111.11111111.11111111.11111100가 서브넷 마스크
            - 255.255.255.252와 같음

---

## 공인 IP 주소와 사설 IP 주소
- 공인 IP
    - 전 세계에서 고유한 IP
    - ISP나 공인 IP 주소 할당 기관을 통해 할당
    - 패킷을 주고 받을 때에는 공인 IP 필요
- 사설 IP
    - 사설 네트워크에서 사용되는 IP
    - 외부 네트워크에는 공유되지 않음
    - 라우터(공유기)를 통해 할당
    - 사설 IP 주소로 사용되도록 특별히 예약된 IP 주소 공간 (예약 주소)
        - `10.0.0.0/8`
        - `172.16.0.0/12`
        - `192.168.0.0/16`
    - 사설 네트워크 상에서 유일한 IP이기 때문에 다른 네트워크에서의 사설 IP와 같을 수 있음

---

## IP 주소의 할당
- `정적 할당`
    - 직접 수작업으로 IP 주소를 부여
    - 운영체제 마다 명령어 존재
    - 수동 할당시 입력해야 하는 필요 값들
        - IP 주소
        - 서브넷 마스크
        - 게이트웨이(라우터) 주소
        - DNS 주소
    - `게이트웨이`
        - 서로 다른 네트워크를 연결하는 하드웨어/소프트웨어적 수단
        - `기본 게이트웨이`, 디폴트 게이트웨이, 디폴트 라우트
            - 호스트가 속한 네트워크의 외부로 나가기 위한 첫 기본 경로를 의미
            - 네트워크 외부와 연결된 라우터(공유기)의 주소를 의미하는 경우가 많음
            - IP 할당의 맥락에서 게이트웨이는 기본 게이트웨이 의미
            - 라우팅 테이블에 따로 경로가 등록되어 있지 않은 패킷은 기본적으로 기본 게이트웨이(라우터)에게 전달
    - DNS 주소
        - 도메인 네임을 토대로 IP 주소를 알아내기 위해 질의하는 서버의 주소
- `동적 할당`
    - 프로토콜을 통해 자동으로 IP 주소 부여
    - 동적 할당을 통해 할당된 IP 주소를 동적 IP 주소(dynamic IP address)라고 함
    - `DHCP`
        - dynamic host configuration protocol
        - 동적 할당에 사용되는 프로토콜
    - 일반적으로 라우터가 DHCP 서버 역할을 수행
    - 기억
        - 동적 IP 주소는 사용 가능한 기간(임대 기간)이 정해져 있음
        - 동적 IP 주소는 할당받을 때마다 다른 주소를 받을 수 있음
    - 일반적으로 두 번 임대 요청을 하고 임대 갱신에 실패하면 IP 주소는 DHCP 서버에 반납됨

---

## `예약 주소`
- 특수한 목적을 위해 예약된 IP 주소
- `127.0.0.1`
    - 루프백 주소, 로컬 호스트
    - 자기 자신을 가리키는 특별한 주소
    - 루프백 주소로 전송된 패킷은 자기 자신에게 되돌아옴
- `0.0.0.0/8`
    - 인터넷 표준 공식 문서(RFC 6890)
        - This host on this network
        - 이 네트워크의 이 호스트를 지칭하도록 예약되었다
    - 호스트가 IP 주소를 할당받기 전에 임시로 할당되는 IP 주소
        - 예) DHCP Discover 메시지를 전송하는 시점의 클라이언트 IP 주소
        - DHCP Discover 메시지를 전송한다는 건 아직 IP 주소를 할당받지 못했다는 것
        - 이렇게 지칭할 IP 주소가 없을 때 사용하는 게 0.0.0.0/8
    - 특별히 지칭할 IP 주소가 없을 때 사용되는 IP 주소
        - 호스트 입장에서 마땅히 자신을 지칭할 IP 주소가 없을 때
- `0.0.0.0/0`
    - 0.0.0.0/8과 유사하지만 다른 의미를 지니는 주소
    - 모든 임의의 IP 주소, 모든 IP 주소를 의미
    - 주로 라우팅에서 `디폴트 라우트`를 나타내기 위해 사용
    - 디폴트 라우트
        - 패킷을 어떤 IP 주소로 전달할지 결정하기 어려울 경우 기본적으로 패킷을 전달할 경로
        - 어디로 패킷을 전달해야 할지 명확하지 않으면 여기로 패킷을 이동시켜라
    - 이도 저도 아닌 경우 0.0.0.0/0에 패킷 전달

---

## IP 전송 특징의 보완: `ICMP`
- 신뢰성을 보장하지 않는 게 항상 단점은 아님. 성능상 이점도 있음
- 다만 보완해야 할 때가 있는데, 그 대 보통 TCP를 사용함
- 또 다른 신뢰성 보완 방법은 ICMP
- `ICMP`
    - Internet Control Message Protocol
    - IP 패킷의 전송과정에 대한 피드백 메시지를 얻기 위해 사용하는 프로토콜
    - 전송 과정에서 발생한 오류 보고, 네트워크 진단 정보가 ICMP 메시지에 담김
    - ping은 ICMP를 기반으로 구현된 대표적인 명령어

---

## IP 주소와 MAC 주소의 대응: `ARP`
- IP 주소로 상대 호스트의 네트워크에 도달 후, MAC 주소를 찾는 프로토콜
- Address Resolution Protocol
- 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아내는 프로토콜
- 과정
    - 네트워크 안에 브로드캐스트로 ARP 요청 보냄
    - ARP 요청 메시지에 알고 싶은 MAC 주소에 대응되는 IP 주소 포함
    - 자신의 IP 주소인 호스트만 자신의 MAC 주소를 ARP 응답으로 전송
    - 호스트는 IP 주소, MAC 주소 쌍을 기억 -> `ARP 테이블`

