# 공유기 왜 쓰지?

공인 아이피는 희소하다. 그래서 돈을 내야 한다. 그런데 요즘에 집 안에 인터넷이 연결되어 있는 기기가 한 곳인 집이 얼마나 될까. 만약 이런 기기들마다 모두 공인 아이피를 할당해준다면 돈이 좀 많이 들 것이다. 집이야 그렇다 쳐도, 카페에 가보면 여러 사람이 와이파이로 인터넷을 사용하는데, 와이 파이에 접속한 모든 사람들에게 공인 아이피를 나눠줘야 한다면 카페에서 지불해야하는 금액은 그만큼 늘어날 것이다. 

하지만 공유기가 그 문제를 해결해준다. 공유기는 하나의 공인 아이피를 나눠쓸 수 있도록 해준다. NAT라는 기술을 사용하여 이를 가능하게 한다.  

공유기는 기기가 연결되면 각 기기에 공유기가 관리하는 내부 아이피를 할당해 준다. 기기가 외부 인터넷에 접속하고자 하면, 공유기 내부 저장소에 테이블에 기록을 한다. (외부 아이피 외부 포트번호) - (내부 아이피 내부 포트번호) 이렇게 기록한다. 그리고 외부로 패킷이 전송될 때에는 외부 아이피와 외부 포트번호가 기록되어 전달된다. 서버는 이 외부 아이피, 포트번호를 보고 공유기에게 응답 메세지를 보내고, 공유기는 테이블을 보고 이 메세지를 해당 기기에게 전달해 준다. 

외부에서는 공유기의 공인 아이피만 알 수 있다. 내부 아이피는 볼 수 없다. 하지만 위 예시에서는 내부 아이피가 외부로 먼저 요청을 한 것이기 때문에 공유기가 테이블에 외부-내부 매칭을 기록할 수 있었다. 반대로 외부에서 내부 아이피로 데이터를 보내려면 어떻게 해야 할까? 이 때에는 테이블에 기록이 되어 있지 않기 때문에 외부에서 내부 아이피에 접근이 안된다.  

그래서 '포트 포워딩'이라는 것을 해주어야 한다. 미리 공유기 설정을 통해, 내부 아이피-포트 번호를 특정 외부 아이피-포트번호와 영구적으로 연결 시켜놓는 것이다. 이렇게 하면, 이 특정 외부 아이피-포트 번호로 오는 모든 패킷은 포트포워딩 신청한 내부 아이피-포트번호로 연결된다.

---
### 참고 
[Network-Address-Translation-NAT-Working-Principle](https://www.researchgate.net/figure/Network-Address-Translation-NAT-Working-Principle_fig4_334557400#:~:text=Network%20Address%20Translation%20(NAT)%20Working%20Principle)

[네트워크 주소 변환](https://ko.wikipedia.org/wiki/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC_%EC%A3%BC%EC%86%8C_%EB%B3%80%ED%99%98)